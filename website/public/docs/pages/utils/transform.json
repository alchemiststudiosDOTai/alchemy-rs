{
  "slug": "utils/transform",
  "title": "Message Transformation",
  "summary": "Cross-provider message transformation for switching models/providers mid-conversation",
  "readWhen": [
    "You need to switch between different LLM providers during a conversation",
    "You want to understand how thinking blocks and tool calls are transformed",
    "You need to handle tool call ID normalization across providers"
  ],
  "content": "\r\n# Message Transformation\r\n\r\nCross-provider message transformation for conversation history compatibility. Handles thinking blocks, tool call IDs, orphaned tool calls, and error filtering.\r\n\r\n**Source:** `src/transform.rs` (~775 lines with tests)\r\n\r\n## Purpose\r\n\r\nWhen switching between models or providers during a conversation, message formats may not be directly compatible. The `transform_messages` function normalizes conversation history for the target model.\r\n\r\n## Key Transformations\r\n\r\n### 1. Thinking Block Handling\r\n\r\nThinking blocks (`<thinking>...</thinking>`) are handled differently based on the target:\r\n\r\n| Source | Target | Action |\r\n|--------|--------|--------|\r\n| Same model + signature | Same model + signature | Keep for replay |\r\n| Same model | Same model | Keep as-is |\r\n| Any | Different model | Convert to plain text |\r\n| Any | Any | Empty thinking is filtered out |\r\n\r\n### 2. Tool Call ID Normalization\r\n\r\nDifferent providers have different ID requirements. The optional `normalize_tool_call_id` function builds a mapping from original IDs to normalized IDs, then applies the mapping to tool results.\r\n\r\n### 3. Orphaned Tool Call Handling\r\n\r\nIf an assistant message contains tool calls but no results follow (e.g., user interrupted), synthetic error results are inserted. This satisfies API requirements that all tool calls must have corresponding results.\r\n\r\n### 4. Error/Abort Filtering\r\n\r\nAssistant messages with `stop_reason: Error` or `Aborted` are filtered out completely. These represent incomplete turns that should not be replayed.\r\n\r\n## API\r\n\r\n### TargetModel\r\n\r\nInformation about the target model for transformation.\r\n\r\n```rust\r\npub struct TargetModel {\r\n    pub api: Api,\r\n    pub provider: Provider,\r\n    pub model_id: String,\r\n}\r\n```\r\n\r\n### transform_messages\r\n\r\nFull transformation with optional tool call ID normalization.\r\n\r\n```rust\r\npub fn transform_messages<F>(\r\n    messages: &[Message],\r\n    target: &TargetModel,\r\n    normalize_tool_call_id: Option<F>,\r\n) -> Vec<Message>\r\nwhere\r\n    F: Fn(&str, &TargetModel, &AssistantMessage) -> String,\r\n```\r\n\r\n**Parameters:**\r\n- `messages`: Source conversation history\r\n- `target`: Target model information\r\n- `normalize_tool_call_id`: Optional function to normalize tool call IDs\r\n\r\n**Returns:** Transformed message vector\r\n\r\n### transform_messages_simple\r\n\r\nConvenience wrapper when no ID normalization is needed.\r\n\r\n```rust\r\npub fn transform_messages_simple(\r\n    messages: &[Message],\r\n    target: &TargetModel,\r\n) -> Vec<Message>\r\n```\r\n\r\n## Usage Examples\r\n\r\n### Basic Transformation (Same Provider)\r\n\r\n```rust\r\nuse alchemy::transform::{transform_messages_simple, TargetModel};\r\nuse alchemy::types::{Api, Provider, KnownProvider};\r\n\r\nlet target = TargetModel {\r\n    api: Api::AnthropicMessages,\r\n    provider: Provider::Known(KnownProvider::Anthropic),\r\n    model_id: \"claude-sonnet-4-20250514\".to_string(),\r\n};\r\n\r\nlet transformed = transform_messages_simple(&messages, &target);\r\n```\r\n\r\n### Cross-Provider with ID Normalization\r\n\r\n```rust\r\nuse alchemy::transform::{transform_messages, TargetModel};\r\nuse alchemy::types::{Api, Provider, KnownProvider};\r\n\r\nlet target = TargetModel {\r\n    api: Api::OpenAICompletions,\r\n    provider: Provider::Known(KnownProvider::OpenAI),\r\n    model_id: \"gpt-4o\".to_string(),\r\n};\r\n\r\n// Normalize Anthropic-style IDs to OpenAI format\r\nlet normalize = |id: &str, _target: &TargetModel, _msg: &AssistantMessage| -> String {\r\n    format!(\"call_{}\", id.replace('-', \"_\"))\r\n};\r\n\r\nlet transformed = transform_messages(&messages, &target, Some(normalize));\r\n```\r\n\r\n## Test Coverage\r\n\r\nThe module includes 15 comprehensive tests covering:\r\n\r\n- User message passthrough\r\n- Error message filtering\r\n- Aborted message filtering\r\n- Thinking block behavior (same/different model, with/without signature)\r\n- Empty thinking filtering\r\n- Text signature stripping\r\n- Tool call ID normalization\r\n- Orphaned tool call synthetic results\r\n- Multiple tool calls with partial results\r\n- Image content passthrough\r\n\r\nRun tests with:\r\n\r\n```bash\r\ncargo test --package alchemy --lib transform\r\n```\r\n\r\n## Implementation Notes\r\n\r\n### Two-Pass Algorithm\r\n\r\n1. **First pass:** Transform each message, build tool call ID mapping\r\n2. **Second pass:** Insert synthetic tool results for orphaned calls\r\n\r\n### State Tracking\r\n\r\nDuring transformation, the algorithm tracks:\r\n- `tool_call_id_map`: Maps original IDs to normalized IDs\r\n- `pending_tool_calls`: Tool calls waiting for results\r\n- `existing_result_ids`: Tool result IDs already seen\r\n\r\n### Signature Stripping\r\n\r\nSignatures (`text_signature`, `thinking_signature`, `thought_signature`) are stripped when transforming to a different model. They are only preserved for exact same-model replay.\r\n\r\n## See Also\r\n\r\n- [`types::Message`](../types/message.md) - Message types\r\n- [`types::Content`](../types/content.md) - Content block types\r\n- [`types::StopReason`](../types/stop_reason.md) - Stop reason enumeration\r\n- Phase 5 plan: `memory-bank/plan/phase-5-cross-provider-features.md`\r\n",
  "category": "utils",
  "order": 999
}